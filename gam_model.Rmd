---
title: "Fit GAM model of spore counts"
output:
  html_document:
    theme: simplex
    toc: true
    toc_float:
      collapsed: no
      smooth_scroll: yes
    code_folding: hide
    toc_depth: 2
    css: style.css
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: sentence
---

```{r markdown-settings, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(
  out.width = '60%',
  fig.width = 7,
  fig.height = 7,
  message = FALSE,
  warning = FALSE
)
```

## Load libraries

```{r session settings}
library("tidyverse")
library("ggpubr")
library("gratia")
library("here")
library("mgcv")
theme_set(theme_pubclean())
```

## Spore proportion chi-squared analysis

Check if the spore type, number of nuclei, affects the dispersal.

(Manuscript's section `Results/3.2`)

```{r x-sq}
set.seed(3)
x <- read_csv(here("data/spore_type.csv"),
              show_col_types = FALSE) %>%
  group_by(meter, spore_nuclei) %>%
  summarise(n = sum(count), .groups = 'drop') %>%
  spread(spore_nuclei, n) %>%
  column_to_rownames('meter') %>%
  chisq.test(simulate.p.value = TRUE) 
```

The major spore type spread expected was the individual spore having a smaller spore size (18.8 µm); however, no statistical differences were recorded in spore type proportion at 100 m to 400 m downwind (P = `r x$p.value`, X-squared = `r x$statistic`).

## Spore dispersal GAM Model

(Manuscript's section `Results/3.3`)

### Load data

```{r load-data}
load(here("data/mod_dat.Rdata"))
```

### Inspect the mod_dat object

```{r inspect-mod-dat}
mod_dat %>% # str
  distinct(field, trap_coord, .keep_all = TRUE) %>%
  select(trap_coord,
         trap_degrees,
         degree_dif,
         wind_degrees,
         wind_speed,
         distance_m) %>%
  print(n = Inf)
```

Based on the use of AIC to evaluate model fit to the data, the following model best fit the data with the smoothed time slice variables, `time_slice`; the wind direction in relation to the traps' placement around the field in terms of degrees, *i.e.* 0--360˚, `degree_dif`; the traps' distance from the harvest field in meters, `distance_m`; and the field and traps themselves as a smoothed term random effect, `field` and `xy`.

```{r fit-m1, eval=TRUE}
mod_dat$xy <- as.factor(paste(mod_dat$x, mod_dat$y))

# create predictor degree diff as per Ben Bolker for circular predictors,
# https://fediscience.org/@bbolker/110856805100981742, see Appendix for screenshot
mod_dat$degree_dif_sin <- sin(2 * pi * mod_dat$degree_dif / 360)

m1 <- gam(
  spore_cm2 ~ s(time_slice, k = 3) +
    s(degree_dif_sin, k = 72) +
    s(distance_m, k = 4) +
    s(field, xy, bs = "re"),
  data = mod_dat,
  select = TRUE,
  method = "REML",
  family = "tw"
)
```

### Inspect Model m1

```{r inspect-m1}
m1
```

#### Check model m1

```{r gam-check-m1}
gam.check(m1)
summary(m1)
```

The model fully converged after 11 iterations.
All of the predictive factors included were significant at *P* \> 0.05 and the smoothed predictors indicate a good fit with residuals being randomly distributed and enough basis functions for them to be properly fit.
The Q-Q plot generally falls along the line indicating a sufficient fit.
There is a bit of a pattern in the residual vs linear predictors but the histogram of residuals is a nice bell-shape.
The response versus fitted values clusters nicely around the 1:1 line.
In all, this model looks to explain the spore dispersal data very well.

#### Check for autocorrelation

Because the data represent spatially and temporally correlated data, it's best to check for any autocorrelation in the residuals.

```{r gam-autocorrelation}
acf(residuals(m1))
pacf(residuals(m1))
```

This looks OK.
There is no major pattern discernible in the ACF or PACF plots that show cause for concern.

### Summarise and visualise model m1

```{r appraise-m1, out.width = '100%', fig.height = 6}
draw(m1)
```

```{r save-m1-summary, eval=FALSE, echo=FALSE}
ggsave(
  last_plot(),
  file = here("plots_manuscript/model_summary.png"),
  width = 8,
  height = 5,
  units = "cm",
  dpi = 300,
  scale = 3
)
ggsave(
  last_plot(),
  file = here("plots_manuscript/model_summary.eps"),
  device = cairo_ps,
  fallback_resolution = 600,
  width = 8,
  height = 5
)
```

### Predict spore dispersal and visualise spore dispersal predictions

```{r predict, eval=TRUE}
dist <- seq(0, 400, by = 100)

# create x and y locations around centroid
xy <- expand_grid(dist, dist)
xy <- unite(data = xy, col = "xy")

newd <- expand_grid(
  time_slice = c(90, 180, 270),
  degree_dif_sin = seq(from = 1, to = 360, by = 2),
  distance_m = dist,
  wind_speed = seq(from = 0, to = 30, by = 2),
  x = dist,
  y = dist,
  xy = xy$xy,
  field = 1
)
  
newd$pred_spore_cm2 <- predict(m1, newd)
```

Visualize the spore dispersal predictions for traps at 0 m, 100 m, 200 m, 300 m, 400 m around the harvest field for sampling times at 90, 180 and 270 minutes after harvest started.

```{r graph-predictions}
predictions <-
  newd %>%
  mutate(pred_spore_cm2 = replace(pred_spore_cm2, pred_spore_cm2 < 0, 0)) %>%
  ggplot(aes(x = as.factor(distance_m), y = pred_spore_cm2)) +
  geom_violin() +
  labs(x = "Distance from harvesting field (m)",
       y = "Predicted Spores / cm²")

predictions
```

```{r save-prediction-graph, eval=FALSE}
ggsave(
  last_plot(),
  file = "plots_manuscript/spore_prediction.png",
  w = 5,
  h = 2,
  scale = 1.2
)
```

## Appendix

Screenshot of Ben Bolker's Toot on fedscience.org regarding constructing a linear model with compass directions as predictor variables and how to handle this in the model.

!["At a quick skim this looks like it's mostly about circular *response* variables. In case this hasn't occurred to you already, I think the simplest thing will be to use sin(direction), cos(direction) as predictors ... (or more precisely sin(2*pi*dir/360) etc. if your directions are in degrees ...)"](images/BBolker_Toot.png)
