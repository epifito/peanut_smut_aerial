---
title: "Fit GAM model of spore counts"
output:
  html_document:
    theme: simplex
    toc: true
    toc_float:
      collapsed: no
      smooth_scroll: yes
    code_folding: hide
    toc_depth: 2
    css: style.css
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: sentence
---

```{r markdown-settings, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(
  out.width = '60%',
  fig.width = 7,
  fig.height = 7,
  message = FALSE,
  warning = FALSE
)
```

## Load libraries

```{r session settings}
library("tidyverse")
library("ggpubr")
library("gratia")
library("here")
library("mgcv")
library("DHARMa")
theme_set(theme_pubclean())
```

## Spore proportion chi-squared analysis

Check if the spore type, number of nuclei, affects the dispersal.

Using the default `chisq.test()` will result in a warning due to small expected values meaning that approximations of p may not be correct.
```r
Warning message:
In chisq.test(.) : Chi-squared approximation may be incorrect
```
Therefore, we will use Monte Carlo simulation to simulate p values.

(Manuscript's section `Results/3.2`)

```{r x-sq}
set.seed(3)
x <- read_csv(here("data/spore_type.csv"),
              show_col_types = FALSE) %>%
  group_by(meter, spore_nuclei) %>%
  summarise(n = sum(count), .groups = 'drop') %>%
  spread(spore_nuclei, n) %>%
  column_to_rownames('meter') %>%
  chisq.test(simulate.p.value = TRUE) 
```

The major spore type spread expected was the individual spore having a smaller spore size (18.8 Âµm); however, no statistical differences were recorded in spore type proportion at 100 m to 400 m downwind (P = `r x$p.value`, X-squared = `r x$statistic`).

## Spore dispersal GAM Model

(Manuscript's section `Results/3.3`)

### Load data

```{r load-data}
load(here("data/mod_dat.Rdata"))
```

### Inspect the mod_dat object

```{r inspect-mod-dat}
mod_dat %>% # str
  distinct(field, trap_coord, .keep_all = TRUE) %>%
  select(trap_coord,
         trap_degrees,
         degree_dif,
         wind_degrees,
         wind_speed,
         distance_m,
         n_spore) %>%
  print(n = Inf)
```

Based on the use of AIC to evaluate model fit to the data, the following GAM best fit the data with the smoothed time slice variables, s(`time_slice`); a smoothed term for the direction from which the wind came using sin to transform the degrees, `s(wind_sin)`; a smoothed term for the distance of the traps from the field, `s(distance_m)` and the field and traps themselves as a smoothed term random effect, `s(field`, `xy`) using a negative binomial family.

```{r fit-m1, eval=TRUE}
# create a factor for the trap locations in Cartesian coords to be used as a random effect
mod_dat$xy <- as.factor(paste(mod_dat$x, mod_dat$y))

# create predictor degree diff as per Ben Bolker for circular predictors,
# https://fediscience.org/@bbolker/110856805100981742, see Appendix for screenshot
mod_dat$wind_sin <- sin(2 * pi * mod_dat$wind_degrees / 360)

m1 <-
  gam(
    n_spore ~ s(time_slice, k = 3) +
      s(distance_m, wind_sin, k = 22) +
      s(field, xy, bs = "re"),
    data = mod_dat,
    select = TRUE,
    method = "REML",
    family = nb()
  )
```

### Inspect Model m1

```{r inspect-m1}
summary(m1)
```

#### Check model m1

```{r gam-check-m1}
gam.check(m1)
summary(m1)
vis.gam(m1,
        theta = 50,
        ticktype = "detailed",
        main = "Time slice and wind direction (sin)")
vis.gam(
  m1,
  theta = 50,
  view = c("wind_sin", "distance_m"),
  ticktype = "detailed",
  main = "Wind direction (sin) and distance from field"
)
vis.gam(
  m1,
  theta = 45,
  phi = 45,
  view = c("field", "xy"),
  ticktype = "detailed",
  main = "Random Effects"
)
draw(m1)

# check residuals using DHARMa
simulateResiduals(m1, plot = TRUE)
```

The model fully converged after 21 iterations.
All of the predictive factors included were significant at *P* \> 0.05.



In all, this model looks to explain the spore dispersal data well enough for this data set.

#### Check for autocorrelation

Because the data represent spatially and temporally correlated data, it's best to check for any autocorrelation in the residuals.

```{r gam-autocorrelation}
acf(residuals(m1))
pacf(residuals(m1))
```

This looks OK.
There is no major pattern discernible in the ACF or PACF plots that show cause for concern.

```{r save-m1-summary, eval=FALSE, echo=FALSE}
appraise(m1)
ggsave(
  last_plot(),
  file = here("plots_manuscript/model_summary.png"),
  width = 8,
  height = 5,
  units = "cm",
  dpi = 300,
  scale = 3
)
ggsave(
  last_plot(),
  file = here("plots_manuscript/model_summary.eps"),
  device = cairo_ps,
  fallback_resolution = 600,
  width = 8,
  height = 5
)
```

### Predict spore dispersal and visualise spore dispersal predictions

```{r predict, eval=TRUE}
dist <- seq(100, 400, by = 100)

newd <- expand_grid(
  time_slice = unique(mod_dat$time_slice),
  wind_sin = unique(mod_dat$wind_sin),
  wind_speed = seq(from = 0.5, to = 8, by = 0.5),
  distance_m = unique(mod_dat$distance_m),
  xy = unique(mod_dat$xy),
  field = 1
)

newd$pred_n_spore <-
  predict(
    object = m1,
    newd,
    type = "response",
    exclude = c("field", "xy")
  )
```

Visualize the spore dispersal predictions for traps at 100 m, 200 m, 300 m, 400 m around the harvest field for sampling times at 90, 180 and 270 minutes after harvest started.

```{r graph-predictions}
predictions <-
  newd %>%
  ggplot(aes(x = as.factor(distance_m), y = pred_n_spore)) +
  geom_boxplot() +
  labs(x = "Distance from harvesting field (m)",
       y = "Predicted Spores (n)")

predictions
```

```{r save-prediction-graph, eval=FALSE}
ggsave(
  predictions,
  file = "plots_manuscript/spore_prediction.png",
  w = 5,
  h = 2,
  scale = 1.2
)
```

## Appendix

Screenshot of Ben Bolker's Toot on fediscience.org regarding constructing a linear model with compass directions as predictor variables and how to handle this in the model.

!["At a quick skim this looks like it's mostly about circular *response* variables. In case this hasn't occurred to you already, I think the simplest thing will be to use sin(direction), cos(direction) as predictors ... (or more precisely sin(2*pi*dir/360) etc. if your directions are in degrees ...)"](images/BBolker_Toot.png)
