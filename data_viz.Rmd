---
title: "Visualise data"
output:
  html_document:
    theme: simplex
    toc: true
    toc_float:
      collapsed: no
      smooth_scroll: yes
    code_folding: hide
    toc_depth: 2
    css: style.css
editor_options: 
  chunk_output_type: console
---

```{r markdown-settings, echo=FALSE}
knitr::opts_chunk$set(
  fig.width = 7,
  fig.height = 7,
  message = FALSE,
  warning = FALSE
)
```

## Load libraries

```{r session settings}
library("knitr")
library("tidyverse")
library("ggpubr")
library("here")
library("clifro")
```


```{r plots settings}
theme_set(theme_pubclean())

central_top_legend <- theme(
    legend.position = "top",
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.background = element_blank(),
    legend.key = element_blank()
  )
```

## Load data

```{r load-data}
load(here("data/dat.Rdata"))
load(here("data/mod_dat.Rdata"))
```

## Plot severely damaged pod indices

```{r sdp-incidence}
ggplot(data = mod_dat) +
  aes(y = field, x = SDP) +
  geom_violin()
```

## Plot spore dispersal density

### Plot spore count densities

Create a density plot of the observed spore dispersal values.

```{r spore-kernel-density}
ggplot(mod_dat, aes(y = spore_cm2)) +
  geom_density()
```

Create a scatter plot and use `stat_smooth()` to fit a line.

```{r spore-dot-density-by-distance}
spore_dot_density_by_distance <- mod_dat %>%
  ggplot(aes(x = distance_m, y = spore_cm2)) +
  geom_point() +
  scale_fill_viridis_c() +
  geom_smooth(col = "grey50",
              method = "gam",
              formula = y ~ s(x, bs = "cs", k = 3)) +
  labs(y = expression(Spores / cm ^ {
    2
  }),
  x = "Distance (m)") +
  facet_grid(. ~ time_slice)
spore_dot_density_by_distance
```

Create a violin plot showing spore distribution at the four distances.

```{r spore-violin-density-by-distance}
ggplot(mod_dat, aes(x = as.factor(distance_m), y = spore_cm2)) +
  geom_violin() +
  labs(y = expression(Spores/cm^{2}),
       x = "Distance (m)")
```

#### Check windspeed effect

Create a hexbin plot to display the number of spores by wind speed and fit a smoothed line to these variables.

```{r spore-windspeed}
ggplot(data = mod_dat, aes(x = wind_speed, y = spore_cm2)) +
  scale_fill_viridis_c() +
  geom_hex() +
  geom_smooth(col = "grey50") +
  labs(y = expression(Spores / cm ^ {
    2
  }),
  x = "Wind Speed (m/s)") +
  central_top_legend +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5))
```

#### Polar coordinates

Create polar coordinate plots that display spore density in each cardinal direction.
Note that the 270 minute traps were deployed from time 0 to 270 minutes, 180 from 0 to 180, and 90 from 0 to 90.
So, here the figure shows an additive effect of the number of spores that were captured over time.
These are not discrete time_slices shown here, they do overlap.

```{r plot-spores}
ggplot(data = mod_dat) +
  aes(
    x = trap_degrees,
    y = distance_m,
    colour = spore_cm2,
    size = spore_cm2
  ) +
  facet_grid(time_slice ~ field) +
  coord_polar(theta = "x",
              start = 0,
              direction = 1) +
  geom_count(alpha = 0.55) +
  scale_colour_viridis_c(
    direction = -1,
    name = "Smut spores/m²",
    guide = "legend",
    breaks = c(10, 100, 200, 300),
    begin = 0,
    end = 0.8
  ) +
  scale_size(
    range = c(1, 8),
    name = "Smut spores/m²",
    breaks = c(10, 100, 200, 300)
  ) +
  scale_x_continuous(
    breaks = c(0, 90, 180, 270),
    expand = c(0, 0),
    limits = c(0, 360),
    labels = c("N", "E", "S", "W"),
    sec.axis = sec_axis(
      ~ . ,
      name = "Field",
      breaks = NULL,
      labels = NULL
    )
  ) +
  scale_y_continuous(
    breaks = c(0, 100, 200, 300, 400),
    limits = c(0, 400),
    sec.axis = sec_axis(
      ~ . ,
      name = "Minutes since harvest beginning",
      breaks = NULL,
      labels = NULL
    )
  ) +
  ylab("Distance (m)") +
  xlab("") +
  central_top_legend +
  guides(color = guide_legend(title.position = "top",
                              title.hjust = 0.5))
```

```{r eval=FALSE}
ggsave(
  last_plot(),
  file = "plots_manuscript/spores_cardinal.png",
  width = 20,
  height = 10,
  units = "cm",
  dpi = 600,
  scale = 1.5
)
```

## Plot wind data

### Wind roses

Using the `wind_rose()` from _clifro_, create windrose plots to visualise windspeeds and directions during the harvest and spread events.

```{r wind-rose}
wind_rose <-
  with(
    mod_dat,
    windrose(
      speed = wind_speed,
      direction = wind_degrees,
      facet = field,
      n_speeds = 5,
      n_col = 3
    )
  )

wind_rose +
  scale_fill_viridis_d(
    name = "Wind Speed (m/s)",
    direction = -1,
    begin = 0,
    end = .8
  ) +
  labs(x = "", y = "") +
  central_top_legend +
  theme_pubclean()+
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = 0.5,
    keywidth = unit(1, "lines"),
    keyheight = unit(1, "lines")
  ))
```

```{r}
ggsave(
  last_plot(),
  file = "plots_manuscript/wind_rose_6_tr.png",
  width = 20,
  height = 10,
  units = "cm",
  dpi = 600,
  scale = 1.5
)
```

## Plot smoothed spore dispersal

Plot spore dispersal as points with median values represented as red points with a line connecting the median values for each respective field.

```{r smoothed-dispersal}
field_names <- as_labeller(c(`1` = "Field 1",
                             `2` = "Field 2",
                             `3` = "Field 3",
                             `4` = "Field 4",
                             `5` = "Field 5",
                             `6` = "Field 6"))
smoothed_dispersal <- mod_dat %>%
  ggplot(aes(x = distance_m, y = spore_cm2)) +
  geom_point(size = 1.5) +
  stat_summary(fun = "median",
               geom = "line",
               na.rm = TRUE) +
  stat_summary(
    fun = "median",
    colour = "red",
    size = 2.5,
    geom = "point"
  ) +
  scale_x_continuous(guide = guide_axis(n.dodge = 2)) +
  facet_grid(. ~ field, labeller = field_names) +
  labs(col = "Prevailing wind",
       x = "Distance from harvesting field (m)",
       y = "Smut spores / m² at trap")
smoothed_dispersal
```

```{r, eval=FALSE}
ggsave(
  last_plot(),
  file = "plots_manuscript/spore_gradient.png",
  w = 6,
  h = 4,
  scale = 1.2
)
```

## Spore type frequency

```{r load-spore-type}
dat_spore_type <- read_csv(here("data/spore_type.csv"))
```

```{r check-spore-type}
head(dat_spore_type)
```

```{r plot-spore-type}
dat_spore_type %>%
  group_by(meter, spore_nuclei, .drop = FALSE) %>%
  summarise(count = mean(count)) %>%
  mutate(percent = count / sum(count)
         # spore_nuclei= fct_rev(factor(spore_nuclei))
         ) -> dat_spore_type_sum

spore_type_plot <- dat_spore_type_sum %>% 
  ggplot(aes(
    x = meter,
    y = percent,
    fill = factor(spore_nuclei)
  )) +
  geom_bar(position = position_fill(reverse = T), stat = "identity", alpha=.9)+
  labs(y = "Proportion",
       x = "Distance from harvesting field (m)",
       fill = "Spore type") +
  # scale_fill_viridis_d(direction = -1) +
  geom_text(data = dat_spore_type_sum %>% 
              mutate(spore_nuclei= fct_rev(factor(spore_nuclei))), 
    aes(label = round(percent, 2)),
    position = position_stack(vjust = 0.5),
    col = "white",
    fontface = "bold",
    size = 3
  ) + 
  theme(#axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) +
  guides(fill="none")
```

## Spore size

```{r load-spore-size}
dat_spore_size <- read_csv(here("data/spore_size.csv"))
```

```{r inspect-spore-size}
head(dat_spore_size)
```

```{r spore-size-ridges}
med_spore_size <- dat_spore_size %>%
  filter(image_id != 34) %>%
  mutate(d_mean = (d1 + d2) / 2, 
         spore_type = as.factor(spore_type)) %>%
  group_by(spore_type) %>%
  summarize(mean=mean(d_mean), 
            sd=sd(d_mean, na.rm = T)) %>% 
  mutate(across(where(is.numeric), round, 1))

med_spore_size
```


```{r spore-size-ridges plot}
spore_size_plot <- dat_spore_size %>%
  filter(image_id != 34) %>%
  mutate(mean = (d1 + d2) / 2) %>%
  ggplot(aes(x = mean)) +
  geom_density(aes(fill = factor(spore_type)), size = .2, alpha = .6) +
  expand_limits(x = c(10, 50), y = c(0, .5)) +
  # scale_fill_viridis_d(direction = -1) +
  geom_vline(data = med_spore_size, aes(xintercept = mean), size = .2) +
  geom_label(
    data = med_spore_size,
    label.size = NA,
    aes(
      x = mean,
      label = paste0(mean, "\n(", sd, ")"),
      y = .48
    ),
    size = 2.54
  ) +
  labs(x = expression(paste("Mean diameter (", mu, m, ")")),
       y = "Density",
       fill = "Spore type")
```

## Create a multipanel figure of spore size details

```{r create-single-figure}
library(patchwork)
spore_size_plot + spore_type_plot + 
  plot_layout(guides = "collect") & 
  theme(legend.position='bottom') &
  scale_fill_viridis_d(direction = -1) &
  plot_annotation(tag_levels = 'A')
```

```{r, eval=FALSE}
ggsave(
  last_plot(),
  file = "plots_manuscript/spore_size_type.jpg",
  width = 8,
  height = 5,
  units = "cm",
  dpi = 300,
  scale = 2
)
```
