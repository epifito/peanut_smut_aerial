---
title: "Fit models"
output:
  html_document:
    theme: simplex
    toc: true
    toc_float:
      collapsed: no
      smooth_scroll: yes
    code_folding: hide
    toc_depth: 2
    css: style.css
---

```{r markdown-settings, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 7,
  fig.height = 7,
  message = FALSE,
  warning = FALSE
)
```

## Load libraries

```{r session settings}
library("tidyverse")
library("broom")
library("ggplot2")
library("ggpubr")
library("gratia")
library("here")
library("mgcv")

theme_set(theme_pubclean())
```

## Load data

```{r load-data}
load(here("data/mod_dat.Rdata"))
```

## Inspect the mod_dat object

```{r inspect-mod-dat}
mod_dat %>%
  distinct(field, trap_coord, .keep_all = TRUE) %>%
  select(trap_coord,
         trap_degrees,
         wind_degrees,
         degree_dif,
         downwind,
         trap_id) %>%
  print(n = Inf)
```

Because of the number of zeros in the data, we will use a [Tweedie family](https://en.wikipedia.org/wiki/Tweedie_distribution) for the models to help account for this, _i.e._ in the model functions you will see `family =  "tw"` for this.

### Model m1

* Response: `spore_cm2`
* Linear predictors: `time_slice`, `distance_m`, `downwind`
* Smoothed predictors: `wind_speed`
* Random effects: `trap_id`

```{r m1}
m1 <- gam(
  spore_cm2 ~ time_slice + distance_m + downwind +
    s(wind_speed, k = 18) +
    s(trap_id, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m1
```

### Model m2

* Response: `spore_cm2`
* Linear predictors: `time_slice`, `distance_m`, `downwind`
* Smoothed predictors: `wind_speed`
* Random effects: `trap_id`, `field`

```{r m2}
m2 <- gam(
  spore_cm2 ~ time_slice + distance_m + downwind +
    s(wind_speed, k = 18) +
    s(trap_id, bs = "re") +
    s(field, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m2
```

### Model m3

* Response: `spore_cm2`
* Linear predictors: `time_slice`, `distance_m`, `downwind`
* Smoothed predictors: `wind_speed`
* Random effects: `trap_id`, `field`, `time_slice`

```{r m3}
m3 <- gam(
  spore_cm2 ~ time_slice + distance_m + downwind +
    s(wind_speed, k = 18) +
    s(trap_id, bs = "re") +
    s(field, bs = "re") +
    s(time_slice, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m3
```

## Model AIC

Check models for best fit using AIC.

```{r AIC}
models <- list(
  m1 = m1,
  m2 = m2,
  m3 = m3
)
map_df(models, glance, .id = "model") %>%
  arrange(AIC, BIC)
```

Based on the AIC and BIC values, model m3 looks to be the best model for our data.

## Inspect Model m3

### Check model

```{r gam-check-m3}
gam.check(m3)
```

The model fully converged after 9 iterations.
All of the predictive factors included were significant at _P_ > 0.05 and the smoothed predictors indicate a good fit with residuals being randomly distributed and enough basis functions for them to be properly fit.
The Q-Q plot generally falls along the line indicating a sufficient fit.
There is a bit of a pattern in the residual vs linear predictors but the histogram of residuals is a nice bell-shape.
The response versus fitted values clusters nicely around the 1:1 line.
In all, this model looks to explain the spore dispersal data very well.

### Summarise and visualise model m3

```{r appraise-m3}
summary(m3)
plot(m3)
```

## Predict spore dispersal

```{r predict}
mod_dat %>% distinct(downwind) %>% pull()
newd <- expand_grid(
  time_slice = c(90, 180, 270),
  downwind = c("downwind", "lateral", "upwind"),
  distance_m = seq(0, 400, 100),
  wind_speed = 0:30,
  field = 1,
  trap_id = as.factor(apply(expand.grid(
    1, c("_N_", "_S_", "_E_", "_W_"), c(100, 200, 300, 400)
  ),
  1, paste, collapse = "")),
  sub_sample = as.factor(c(1, 2))
)
  
newd$pred_spore_cm2 <- predict(m3, newd)
```

## Visualise spore dispersal predictions

Visualise the spore dispersal predictions for the three time-slices, 90, 180 and 270 minutes at 0m to 400m.

```{r graph-predictions, fig.cap="Predictions of spore dispersal (spores per meter squared) at 0m to 400m for three time points, 90 min, 180 min, 270 min after peanut harvest commenced."}
newd %>%
  ggplot(aes(x = distance_m, y = pred_spore_cm2, col = downwind)) +
  geom_smooth(method = "gam",
              formula = y ~ s(x, k = 5),
              size = 1) +
  scale_fill_viridis_d("Prevailing wind") +
  scale_colour_viridis_d("Prevailing Wind") +
  facet_grid(. ~ time_slice) +
  scale_x_continuous(sec.axis = sec_axis(
    ~ . ,
    name = "Minutes since harvest beginning",
    breaks = NULL,
    labels = NULL
  )) +
  labs(x = "Distance from harvesting field (m)",
       y = "Spores / mÂ²") +
  theme(
    legend.position = "top",
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.background = element_blank(),
    legend.key = element_blank()
  ) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5))
```

```{r save-prediction-graph, eval=FALSE}
ggsave(
  last_plot(),
  file = "plots/spore_prediction.png",
  w = 5,
  h = 2,
  scale = 1.2
)
```
