---
title: "Fit models"
output:
  html_document:
    theme: simplex
    toc: true
    toc_float:
      collapsed: no
      smooth_scroll: yes
    code_folding: hide
    toc_depth: 2
    css: style.css
---

```{r markdown-settings, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(
  fig.width = 7,
  fig.height = 7,
  message = FALSE,
  warning = FALSE
)
```

## Load libraries

```{r session settings}
library("tidyverse")
library("broom")
library("ggplot2")
library("ggpubr")
library("gratia")
library("here")
library("mgcv")

theme_set(theme_pubclean())
```

## Load data

```{r load-data}
load(here("data/dat.Rdata"))
load(here("data/mod_dat.Rdata"))
```

## Inspect the mod_dat data

```{r inspect-mod-dat}
mod_dat %>%
  distinct(field, trap_coord, .keep_all = TRUE) %>%
  select(trap_coord,
         trap_degrees,
         wind_dir,
         wind_degrees,
         degree_dif,
         downwind) %>%
  print(n = Inf)
```

Because of the number of zeros in the data, we will use a [Tweedie family](https://en.wikipedia.org/wiki/Tweedie_distribution) for the models to help account for this, _i.e._ in the model functions you will see `family =  "tw"` for this.

### Model 1

* Response: `spore_cm2`
* Linear predictors: `distance_m:time_min`
* Random effects: `field`

```{r m1}
m1 <- gam(
  spore_cm2 ~ distance_m:time_min +
    s(field, bs = "re"),
  data = mod_dat,
  method = "REML",
  family = "tw"
)
m1
```

### Model 2

* Response: `spore_cm2`
* Linear predictors: `distance_m:time_min`
* Smoothed predictors: `downwind`
* Random effects: `field`

```{r m2}
m2 <- gam(
  spore_cm2 ~ distance_m:time_min +
    s(field, bs = "re") +
    s(downwind, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m2
```

### Model 3

* Response: `spore_cm2`
* Linear predictors: `distance_m:time_min`
* Random effects: `field`, `downwind`, `wind_speed`

```{r m3}
m3 <- gam(
  spore_cm2 ~ distance_m:time_min +
    s(wind_speed, bs = "re") +
    s(field, bs = "re") +
    s(downwind, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m3
```

### Model 4

* Response: `spore_cm2`
* Linear predictors: `time_min`, `downwind`, `wind_speed`
* Smoothed predictors: `distance_m`
* Random effects: `field`

```{r m4}
m4 <- gam(
  spore_cm2 ~ time_min + downwind + wind_speed +
    s(distance_m, k = 3) +
    s(field, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m4
```

### Model 4.1

* Response: `spore_cm2`
* Linear predictors: `time_min`, `downwind`, `wind_speed`
* Smoothed predictors: `distance_m`
* Random effects: `field`, `time_min`

```{r m4.1}
m4.1 <- gam(
  spore_cm2 ~ time_min + downwind + wind_speed +
    s(distance_m, k = 3) +
    s(time_min, bs = "re") +
    s(field, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m4.1
```

### Model 5

* Response: `spore_cm2`
* Linear predictors: `time_min`, `downwind`
* Smoothed predictors: `distance_m`
* Random effects: `field`

```{r m5}
m5 <- gam(
  spore_cm2 ~ time_min + downwind +
    s(distance_m, k = 3) +
    s(field, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m5
```

### Model 6

* Response: `spore_cm2`
* Linear predictors: `time_min`, `distance_m`, `downwind`
* Random effects: `field`

```{r m6}
m6 <- gam(
  spore_cm2 ~ time_min + distance_m + downwind + s(field, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m6
```

### Model 7

* Response: `spore_cm2`
* Linear predictors: `time_min`, `distance_m`, `downwind`, `wind_speed`, `rel_hum`, `temp`, `wind_speed`, `smut_incidence`
* Smoothed predictors: `distance_m`
* Random effects: `field`, `time_min`

```{r m7}
m7 <- gam(
  spore_cm2 ~ distance_m + downwind + time_min +
    s(wind_speed, k = 6) +
    s(field, bs = "re"),
  method = "REML",
  data = mod_dat,
  family = "tw"
)
m7
```

## Model AIC

Check models for best fit using AIC.

```{r AIC}
models <- list(
  m1 = m1,
  m2 = m2,
  m3 = m3,
  m4 = m4,
  m4.1 = m4.1,
  m5 = m5,
  m6 = m6,
  m7 = m7
)
map_df(models, glance, .id = "model") %>%
  arrange(AIC)
```


Based on the AIC, model m6 looks to be the best model for our data.

## Inspect model m6

```{r summarise-m6}
appraise(m6)
summary(m6)
```

```{r visualise-gam}
draw(m6)
```

## Predict spore dispersal

```{r predict}
mod_dat %>% distinct(downwind) %>% pull()
newd <- expand_grid(
  time_min = c(90, 180, 270),
  downwind = c("downwind", "lateral", "upwind"),
  distance_m = seq(0, 400, 100),
  wind_speed = 0:30,
  field = 5
)
newd$pred_spore_cm2 <- predict(m6, newd)
```

## Visualise spore dispersal predictions

The GAM will predict spores to disperse at negative values, since this is not possible, we will set any values that are less than zero to zero in the model's output before plotting.

```{r graph-predictions, fig.cap="Predictions of spore dispersal (spores per meter squared) at 0m to 400m for three time points, 90 min, 180 min, 270 min after peanut harvest commenced."}
newd %>%
  mutate(pred_spore_cm2 = replace(pred_spore_cm2, pred_spore_cm2 < 0, 0)) %>%
  ggplot(aes(x = distance_m, y = pred_spore_cm2, col = downwind)) +
  geom_point() +
  geom_smooth() +
  scale_fill_viridis_d("Prevailing wind") +
  scale_colour_viridis_d("Prevailing Wind") +
  facet_grid(. ~ time_min) +
  scale_x_continuous(sec.axis = sec_axis(
    ~ . ,
    name = "Minutes since harvest beginning",
    breaks = NULL,
    labels = NULL
  )) +
  labs(x = "Distance from harvesting field (m)",
       y = "Spores / mÂ²") +
  theme(
    legend.position = "top",
    legend.justification = "center",
    legend.direction = "horizontal",
    legend.background = element_blank(),
    legend.key = element_blank()
  ) +
  guides(fill = guide_legend(title.position = "top",
                             title.hjust = 0.5))
```

```{r save-prediction-graph, eval=FALSE}
ggsave(
  last_plot(),
  file = "plots/spore_prediction.png",
  w = 5,
  h = 2,
  scale = 1.2
)
```



